<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World</title>
</head>
<body>
    <p>Stock Trader</p>
    <form method ="post" name="stock" onsubmit="myFunction(); return false;">
        <p>Stock:</p>
        <p></p><input type="text" id = "input" required></p>
        <p></p><input type="submit" value="submit" ></p>
        <p></p><input type="reset" value="clear"></p>
    </form>
    <div id="outlookTable"></div>
    <div id="summaryTable"></div>
    <div id="chart-graph"></div>
    <p id="chartData"></p>

</body>

<script type="text/javascript">
    stock_ticker = ""; 
    today_date="";
    function myFunction() {
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() 
        {
            if(xhttp.readyState==4 && xhttp.status ==200) {
                var stock_tiker_time = JSON.parse(xhttp.response);
                stock_ticker = stock_tiker_time[0]; 
                today_date = stock_tiker_time[1]
                document.getElementById("input").value = stock_ticker;
                request_info(stock_ticker, request_type="outlook", loadFunc=loadOutlook);
                request_info(stock_ticker, request_type="summary", loadFunc=loadSummary);
                request_info(stock_ticker, request_type="chart", loadFunc=loadChart);
            }
        }
        xhttp.open("GET", "/api/stockName?symbol="+document.getElementById("input").value);
        xhttp.send();
    };

    function request_info(stock_ticker, request_type, loadFunc){ //pass loadFunc as var
        let stock_request = new XMLHttpRequest(); //function variable
        stock_request.onreadystatechange = function()
        {
            if(stock_request.readyState==4 && stock_request.status ==200) {
                var response_obj = JSON.parse(stock_request.responseText); // convert to json
                loadFunc(response_obj);
            }
        }
        stock_request.open("GET", "/api/"+request_type+"?symbol="+stock_ticker);
        stock_request.send();
    }

    function loadOutlook(response) 
    {
        html = ["<table>", "<tr>", "<td>"];
        html.push
        //company name
        html.push("Company Name");
        html.push("</td>");
        html.push("<td>");
        html.push(response.name);
        html.push("</td>");
        html.push("</tr>");
        //ticker symbol
        html.push("<tr>")
        html.push("<td>");
        html.push("Stock Ticker Symbol");
        html.push("</td>");
        html.push("<td>");
        html.push(response.ticker);
        html.push("</td>");
        html.push("</tr>");

        //stock exchange code
        html.push("<tr>")
        html.push("<td>");
        html.push("Stock Exchange Code");
        html.push("</td>");
        html.push("<td>");
        html.push(response.exchangeCode);
        html.push("</td>");
        html.push("</tr>");
        //company start date
        html.push("<tr>")
        html.push("<td>");
        html.push("Company Start Date");
        html.push("</td>");
        html.push("<td>");
        html.push(response.startDate);
        html.push("</td>");
        html.push("</tr>");

        //description
        html.push("<tr>")
        html.push("<td>");
        html.push("Description");
        html.push("</td>");
        html.push("<td>");
        html.push(response.description);
        html.push("</td>");
        html.push("</tr>");
        html.push("</table>");
        document.getElementById("outlookTable").innerHTML = html.join("");
    }

    function loadSummary(response) 
    {
        response = response[0];
        html = ["<table>", "<tr>", "<td>"];
        html.push
        //Stock Ticker Symbol
        html.push("Stock Ticker Symbol");
        html.push("</td>");
        html.push("<td>");
        html.push(response.ticker);
        html.push("</td>");
        html.push("</tr>");
        //Trading Day
        html.push("<tr>")
        html.push("<td>");
        html.push("Trading Day");
        html.push("</td>");
        html.push("<td>");
        html.push(response.timestamp.substring(0,10));
        html.push("</td>");
        html.push("</tr>");
        //Previous Closing Price
        html.push("<tr>")
        html.push("<td>");
        html.push("Previous Closing Price");
        html.push("</td>");
        html.push("<td>");
        html.push(parseFloat(response.prevClose));
        html.push("</td>");
        html.push("</tr>");
        //Opening Price
        html.push("<tr>")
        html.push("<td>");
        html.push("Opening Price");
        html.push("</td>");
        html.push("<td>");
        html.push(parseFloat(response.open));
        html.push("</td>");
        html.push("</tr>");

        //High Price
        html.push("<tr>")
        html.push("<td>");
        html.push("High Price");
        html.push("</td>");
        html.push("<td>");
        html.push(parseFloat(response.high));
        html.push("</td>");
        html.push("</tr>");

        //Low Price
        html.push("<tr>")
        html.push("<td>");
        html.push("Low Price");
        html.push("</td>");
        html.push("<td>");
        html.push(parseFloat(response.low));
        html.push("</td>");
        html.push("</tr>");

        //Last Price
        html.push("<tr>")
        html.push("<td>");
        html.push("Last Price");
        html.push("</td>");
        html.push("<td>");
        html.push(parseFloat(response.last));
        html.push("</td>");
        html.push("</tr>");
        
        //Change
        var change = parseFloat(response.last) - parseFloat(response.prevClose);
        html.push("<tr>")
        html.push("<td>");
        html.push("Change");
        html.push("</td>");
        html.push("<td>");
        html.push(change.toFixed(2));
        html.push("</td>");
        html.push("</tr>");
        

        //Change Percent
        var change_percent = (change/parseFloat(response.prevClose))*100;
        html.push("<tr>")
        html.push("<td>");
        html.push("Change Percent");
        html.push("</td>");
        html.push("<td>");
        html.push(change_percent.toFixed(2));
        html.push("</td>");
        html.push("</tr>");

        //Number of Shares Traded
        html.push("<tr>")
        html.push("<td>");
        html.push("Number of Shares Traded");
        html.push("</td>");
        html.push("<td>");
        html.push(response.volume);
        html.push("</td>");
        html.push("</tr>");

        html.push("</table>");
        document.getElementById("summaryTable").innerHTML = html.join("");
    }

    function loadChart(response) 
    {
        var price_series = [];
        var volume_series = [];

        var i = 0;
        for (i = 0; i<response.length; i++) //iterate through daily data
        {
            var close_price = response[i].close;
            var volume = response[i].volume;
            var date_string = response[i].date.substring(0,10);
            var date = Date.parse(date_string);
            if (date_string!=null) 
            {
                price_series.push([date, close_price]);
                volume_series.push([date, volume]);
            }
        };

        // Create the chart
        Highcharts.stockChart('chart-graph', {

            rangeSelector: {
                buttons: [{
                    type: 'day',
                    count: 7,
                    text: '7d'
                }, {
                    type: 'day',
                    count: 15,
                    text: '15d'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1m'
                }, {
                    type: 'month',
                    count: 3,
                    text: '3m'
                }, {
                    type: 'month',
                    count: 6,
                    text: '6m'
                }],
                selected: 5,
                inputEnabled: false
            },

            title: {
                text: 'Stock Price ' + stock_ticker + " " + today_date,
            },

            subtitle: {
                useHTML: true,
                text: '<a href="https://api.tiingo.com/"><u>Source: Tiingo</u></a>',
            },

            yAxis: [
                {
                    title: {
                        text: 'Stock Price'
                    }
                },
                {
                    title: {
                        text: 'Volume'
                    },
                    opposite:true
                }
            ],

            series: [{
                name: 'Stock Price',
                data: price_series,
                type: 'area',
                yAxis: 0,
                threshold: null,
                tooltip: {
                    valueDecimals: 2
                },
                fillColor: {
                    linearGradient: {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                    },
                    stops: [
                        [0, Highcharts.getOptions().colors[0]],
                        [1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                    ]
                }
            }, {
                name: 'Volume',
                data: volume_series,
                type: 'column',
                yAxis: 1,
                threshold: null,
                tooltip: {
                    valueDecimals: 0
                },
                fillColor: {
                    linearGradient: {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                    },
                    stops: [
                        [0, Highcharts.getOptions().colors[0]],
                        [1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                    ]
                }
            }]
        });
        // document.getElementById("chartData").innerHTML = volume_series;
    }
</script>
<!-- high chart js -->
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/data.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.highcharts.com/stock/modules/export-data.js"></script>

</html>